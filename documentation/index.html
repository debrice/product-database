<html>
<head>
    <title>Product Database Project</title>
    <style type="text/css">
    body{
        font-familly: Verdana,sans-serif;
        color: #444;
        width: 80%;
        margin: auto;
    }

    h1, h2, h3 {
        font-family:"Trebuchet MS",sans-serif;
        font-weight:normal;
        color: #222;
        text-transform: capitalize;
        letter-spacing: -1px;
    }
    
    h1 {
        border-bottom: 1px solid gray;
    }

    h2 {
        font-size: 1.2em;
    }

    h3 {
        font-size: 1.1em;
    }
    #title{
        clear: both;
        font-style: italic;
        color: gray;
        text-align: center;
    }

    #title span{
        font-size: 2em;
        color: black;
        font-style: normal;
        letter-spacing: -2px;
        font-weight: bold;
        text-transform: capitalize;
    }
        
    pre{
        border: 1px solid gray;
        background: #fafafa;
        padding: 5px;
        margin: 10px;
        font-family: Courier, monospace;
        font-size: .8em;
        color: black;
    }

    a:hover{
        color: #2B5C8C;
        text-decoration: underline;
    }

    a{
        text-decoration: none;
        color: #4183C4;
    }
    
    </style>
</head>

<body>
<div id="title">
    <span> product database project</span><br />
    Documentation - Brice Leroy     
</div>
<h1>Setup</h1>
<p>
This section will explain how to setup the server and its dependancies on a Ubuntu platform. 
Ubuntu must be setup and running on the server. For instance, I'm using the version 8.04 on the 
production server:
<pre>
brice@pdb:~$ lsb_release -a
No LSB modules are available.
Distributor ID:	Ubuntu
Description:	Ubuntu 8.04.2
Release:	8.04
Codename:	hardy
</pre>
You can download this version at <a href="http://www.ubuntu.com/getubuntu/download"> ubuntu download
page</a>. Feel free to use an upgraded version, it shouldn't be an issue since Django sources
are used. My user(brice) has sudo right access. First, make sure that your repository informations and 
your ubuntu are up to date:
<pre>
brice@pdb:~$ sudo apt-get update
[sudo] password for brice: 
Get:1 http://security.ubuntu.com hardy-security Release.gpg [189B]
Hit http://archive.ubuntu.com hardy Release.gpg
...
Get:16 http://archive.ubuntu.com hardy-updates/universe Sources [45.5kB]                                                                                                                                               
Fetched 1329kB in 10s (129kB/s)                                                                                                                                                                                        
Reading package lists... Done
brice@pdb:~$ sudo apt-get dist-upgrade
Reading package lists... Done
Building dependency tree       
...
brice@pdb:~$
</pre>
<p>
You should now be ready for the next step.
</p>
<h2>firewall</h2>
<p>We will only need the SSH, HTTP and HTTPS open on our server. So lets close all the other port
on the server. Edit a file named <code>/etc/iptables.up.rules</code> to put those iptables rules:</p>
<pre>
brice@pdb:~$ sudo -i
root@pdb:~# vi /etc/iptables.up.rules 
root@pdb:~# iptables-restore < /etc/iptables.up.rules 
root@pdb:~# iptables -L
Chain INPUT (policy ACCEPT)
target     prot opt source               destination         
ACCEPT     all  --  anywhere             anywhere            
REJECT     all  --  anywhere             127.0.0.0/8         reject-with icmp-port-unreachable 
ACCEPT     all  --  anywhere             anywhere            state RELATED,ESTABLISHED 
ACCEPT     tcp  --  anywhere             anywhere            tcp dpt:www 
ACCEPT     tcp  --  anywhere             anywhere            tcp dpt:https 
ACCEPT     tcp  --  anywhere             anywhere            state NEW tcp dpt:ssh 
ACCEPT     icmp --  anywhere             anywhere            icmp echo-request 
LOG        all  --  anywhere             anywhere            limit: avg 5/min burst 5 LOG level debug prefix `iptables denied: ' 
REJECT     all  --  anywhere             anywhere            reject-with icmp-port-unreachable 

Chain FORWARD (policy ACCEPT)
target     prot opt source               destination         
REJECT     all  --  anywhere             anywhere            reject-with icmp-port-unreachable 

Chain OUTPUT (policy ACCEPT)
target     prot opt source               destination         
ACCEPT     all  --  anywhere             anywhere            
root@pdb:~# 
</pre>
<p>Here is the iptables configuration:</p>
<pre>
# Generated by iptables-save v1.3.8 on Mon Oct 19 16:04:41 2009
*filter
:INPUT ACCEPT [0:0]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]
-A INPUT -i lo -j ACCEPT
-A INPUT -d 127.0.0.0/255.0.0.0 -i ! lo -j REJECT --reject-with icmp-port-unreachable
-A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT
-A INPUT -p tcp -m tcp --dport 80 -j ACCEPT
-A INPUT -p tcp -m tcp --dport 443 -j ACCEPT
-A INPUT -p tcp -m state --state NEW -m tcp --dport 22 -j ACCEPT
-A INPUT -p icmp -m icmp --icmp-type 8 -j ACCEPT
-A INPUT -m limit --limit 5/min -j LOG --log-prefix "iptables denied: " --log-level 7
-A INPUT -j REJECT --reject-with icmp-port-unreachable
-A FORWARD -j REJECT --reject-with icmp-port-unreachable
-A OUTPUT -j ACCEPT
COMMIT
# Completed on Mon Oct 19 16:04:41 2009
</pre>
<p>Now we need to setup this connection to start right before the network interface are loaded.
To do so, you need to edit the <code>/etc/network/interfaces</code> and add the pre-up line just 
after <code>iface lo inet loopback</code>:</p>
<pre>
# Used by ifup(8) and ifdown(8). See the interfaces(5) manpage or
# /usr/share/doc/ifupdown/examples for more information.
# The loopback network interface
auto lo
iface lo inet loopback
pre-up iptables-restore < /etc/iptables.up.rules

# The primary network interface
# Uncomment this and configure after the system has booted for the first time
auto eth0
iface eth0 inet static
    address 174.143.153.5
    netmask 255.255.255.0
    gateway 174.143.153.1
    dns-nameservers 72.3.128.240 72.3.128.241
...
</pre>
<h2>web server</h2>
<p>
Nginx will be used as a proxy and static file server, it will also manage the SSL certificate. since
Django is not a web server, it's better to use a third part application to manage the communication.
So lets install NGinX:
<pre>
brice@pdb:~$ sudo apt-get install nginx
Reading package lists... Done
Building dependency tree       
Reading state information... Done
The following NEW packages will be installed:
  nginx
0 upgraded, 1 newly installed, 0 to remove and 0 not upgraded.
...
Unpacking nginx (from .../nginx_0.5.33-1ubuntu0.1_amd64.deb) ...
Setting up nginx (0.5.33-1ubuntu0.1) ...

brice@pdb:~$ 
</pre>
We will now need to generate the CSR certificate to be able to sign ou SSL certificate. We will use
openssl:
<pre>
brice@pdb:~$ sudo apt-get install openssl
[sudo] password for brice: 
Reading package lists... Done
Building dependency tree       
...
Setting up openssl (0.9.8g-4ubuntu3.8) ...
brice@pdb:~$ openssl req -new -newkey rsa:2048 -nodes -out pdb_fulham_com.csr \
> -keyout pdb_fulham_com.key -subj \
> "/C=US/ST=California/L=Hawthorne/O=Fulham Co. Inc./CN=pdb.fulham.com"
Generating a 2048 bit RSA private key
........................................................................................................................................+++
....................+++
writing new private key to 'pdb_fulham_com.key'
-----
brice@pdb:~$ 
</pre>
Once generated, I generated the SSL cerficate through godaddy and validated it by checking 
it@fulham.com (official fulham.com mail). The next step was the generation of the web certificate 
and placing it at the right place on the server config directory
</p>
<pre>
brice@pdb:~$ sudo su
[sudo] password for brice: 
root@pdb:/home/brice# sudo cat pdb.fulham.com.crt gd_bundle.crt > /etc/nginx/pdb.fulham.com.crt
root@pdb:/home/brice# cp pdb_fulham_com.key /etc/nginx/                   
</pre>
<p>
Now we will setup nginx site to enable the ssl.
</p>
<pre>
root@pdb:/home/brice# rm /etc/nginx/sites-enabled/default 
root@pdb:/home/brice# vi /etc/nginx/sites-available/pdb.fulham.com
</pre>
<p>
and here is the configuration for pdb.fulham.com:
</p>
<pre>
server {
    # redirect every HTTP request to HTTPS
    listen   80;
    server_name  pdb.fulham.com;
    location / {
        rewrite ^ https://pdb.fulham.com$request_uri? permanent;
    }
}


server {
    listen 443;
    ssl on;
    ssl_certificate /etc/nginx/pdb.fulham.com.crt;
    ssl_certificate_key /etc/nginx/pdb_fulham_com.key;

    server_name pdb.fulham.com;

    access_log  /var/log/nginx/pdb.fulham.com.access.log;
    error_log  /var/log/nginx/pdb.fulham.com.error.log;

    #add_header           Front-End-Https    on;
    proxy_set_header X-Url-Scheme $scheme;

    location / {
        proxy_pass http://127.0.0.1:9000/;
        proxy_set_header X-Forwarded-Protocol "https";
        proxy_set_header  Host       $host;
        proxy_set_header  X-Real-IP  $remote_addr;
        client_max_body_size       3000m;
    }

    location /media/ {
        alias /home/brice/productdatabase/media/;
    }

    location /static/ {
        alias /home/brice/productdatabase/static/;
    }

    location /adminmedia/ {
        alias /usr/lib/python2.5/site-packages/django/contrib/admin/media/;
    }

    error_page   500 502 503 504  /50x.html;
    location = /50x.html {
        root   /var/www/nginx-default;
    }
}

</pre>
<p>
Then we have to:
</p>
<ul>
    <li>Activate the website</li>
    <li>create the log folder (if it doesn't exist)</li>
    <li>restart nginx</li>
</ul>
<pre>
root@pdb:/home/brice# ln -s /etc/nginx/sites-available/pdb.fulham.com /etc/nginx/sites-enabled/pdb.fulham.com
root@pdb:/home/brice# ls -l /etc/nginx/sites-enabled/   
total 0
lrwxrwxrwx 1 root root 41 Oct 15 21:10 pdb.fulham.com -> /etc/nginx/sites-available/pdb.fulham.com
root@pdb:/home/brice# mkdir /var/log/nginx
root@pdb:/home/brice# /etc/init.d/nginx stop 
Stopping nginx: nginx.
root@pdb:/home/brice# /etc/init.d/nginx start
Starting nginx: nginx.
</pre>
<p> That's all for nginx, it should be now up and running on port 443 (https).
<h2>database server</h2>
<p>
MySQL V5 is used to store the data. A couple of other dependencies should come with it, so don't be
surprised. The installation process will also ask you for a password. The password doesn't have to 
be too complicated because the dbd will only be accessible on localhost and an additionnal firewall 
will be setup to protect it.
</p>
<pre>
root@pdb:/home/brice# sudo apt-get install mysql-server
Reading package lists... Done
Building dependency tree       
...
root@pdb:/home/brice# mysql -u root -p
mysql> create database pdb;
Query OK, 1 row affected (0.00 sec)

mysql> grant usage on *.* to pdb_user@localhost identified by 'your_password_here';
Query OK, 0 rows affected (0.00 sec)

mysql> grant all privileges on pdb.* to pdb_user@localhost;
Query OK, 0 rows affected (0.00 sec)
</pre>
<p>The database should now be accessible localy by the user pdb_user and the password you set.
If you want you can check the db creation status with this command in the mysql console:</p>
<pre>
mysql> show databases;
+--------------------+
| Database           |
+--------------------+
| information_schema | 
| mysql              | 
| pdb                | 
+--------------------+
3 rows in set (0.00 sec)

</pre>
<p>
Now we will create a database and a user for this database. 
</p>
<h2>django</h2>
<p>
We will install django framework using the official repository. to do it we need subversion to be
installed. We will first leave the root mode for more security.
</p>
<pre>
root@pdb:/home/brice# exit
exit
brice@pdb:~$ sudo apt-get install subversion
[sudo] password for brice: 
Reading package lists... Done
Building dependency tree       
...
brice@pdb:~$ svn co http://code.djangoproject.com/svn/django/trunk/ django-trunk 
A    django/LICENSE
A    django/django
...
 U   django
Checked out revision 11627.
brice@pdb:~$
</pre>
<p> Now that we have the repository downloaded in our Django, we have to install it. We will also
need the python to mysql library, so Django can use MySQL.
</p>
<pre>
brice@pdb:~$ sudo ln -s `pwd`/django-trunk/django /usr/lib/python2.5/site-packages/
brice@pdb:~$ sudo ln -s `pwd`/django-trunk/django/bin/django-admin.py /usr/local/bin
brice@pdb:~$ sudo apt-get install python-mysqldb
Reading package lists... Done
Building dependency tree       
Reading state information... Done
...
brice@pdb:~$ 
</pre>
<h2>external app</h2>
<p> The product database application is using differents application to work correctly. Those are
django pluggable ones. 
<h3>django_restapi</h3>
<p> This API is used to provide access to the database through the protocol REST.
<pre>
brice@pdb:~$ svn checkout http://django-rest-interface.googlecode.com/svn/trunk/ django-rest-interface 
A    django-rest-interface/__init__.py
A    django-rest-interface/django_restapi
A    django-rest-interface/django_restapi/__init__.py
...
brice@pdb:~$ sudo ln -s `pwd`/django-rest-interface/django_restapi /usr/lib/python2.5/site-packages/
</pre>
<p>
Django rest interface is not including the user in the request. This patch is adding this 
functionality.
</p>
<pre>
Index: authentication.py
===================================================================
--- authentication.py	(revision 81)
+++ authentication.py	(working copy)
@@ -62,6 +62,12 @@
             return False
         auth = auth.strip().decode('base64')
         username, password = auth.split(':', 1)
+
+        from django.contrib.auth import authenticate
+        user = authenticate(username=username, password=password)
+        if user is not None and user.is_active:
+            request.user = user
+
         return self.authfunc(username=username, password=password)
 
 def digest_password(realm, username, password):
</pre>
<p>
 Without this patch, 80% of the rest product unit test will fail.
 To apply the patch, save this in file named authentication.py in /django-rest-interface/django_restapi
 folder and run the following command:
</p>
<pre>
brice@pdb:~/django-rest-interface/django_restapi$ patch authentication.py authentication.py.patch
</pre>
<h3>django extension</h3>
<p> Django extension provide all kind of small tool in addition to the django manager built in
functionnalities. We will also install graphviz to be able to use the generated db schema. </p>
<pre>
brice@pdb:~$ sudo apt-get install graphviz python-pygraphviz
Reading package lists... Done
Building dependency tree       
...
brice@pdb:~$ hg clone http://hgsvn.trbs.net/django-command-extensions
brice@pdb:~$ cd django-command-extensions/
brice@pdb:~/django-command-extensions$ sudo python setup.py install
[sudo] password for brice: 
running install
...
running install_egg_info
Writing /usr/lib/python2.5/site-packages/django_extensions-0.4.egg-info
brice@pdb:~/django-command-extensions$ 
</pre>
<p> To generate a picture of the actual db schema use the following command</p>
<pre>
brice@pdb:~$ cd productdatabase
brice@pdb:~/productdatabase$ ./manage.py graph_models -a -g -o  ../documentation/db_schema.png
brice@pdb:~$ 
</pre>
<p>
The picture should be available here : <a href="db_schema.png">http://pdb.fulham.com/doc/db_schema.png</a>
</p>
<h3>djangodblog</h3>
<p>This library simplify error management in the website by storing all the differents exception
raised by the software
</p>
<pre>
brice@pdb:~$ sudo apt-get install git-core
Reading package lists... Done
Building dependency tree       
Reading state information... Done
...
brice@pdb:~$ git clone git://github.com/dcramer/django-db-log.git
Initialized empty Git repository in /home/brice/django-db-log/.git/
remote: Counting objects: 60, done.
remote: Compressing objects: 100% (42/42), done.
remote: Total 60 (delta 18), reused 47 (delta 14)
Receiving objects: 100% (60/60), 7.90 KiB, done.
Resolving deltas: 100% (18/18), done.
brice@pdb:~$ sudo ln -s `pwd`/django-db-log/djangodblog/ /usr/lib/python2.5/site-packages/
</pre>
<h3>sorl.thumbnail</h3>
SORL is used to manage thumbnails easily inside django template. This library need image magick 
library to work and mercurial to be downloaded.
<pre>
brice@pdb:~$ sudo apt-get install mercurial
Reading package lists... Done
Building dependency tree       
Reading state information... Done
...
brice@pdb:~$ hg clone https://sorl-thumbnail.googlecode.com/hg/ sorl
requesting all changes
adding changesets
adding manifests
adding file changes
added 362 changesets with 640 changes to 86 files (+5 heads)
30 files updated, 0 files merged, 0 files removed, 0 files unresolved
brice@pdb:~$ sudo ln -s `pwd`/sorl/sorl/ /usr/lib/python2.5/site-packages/ 
</pre>
<h2>mail server</h2>
<p>I use postfix as mail server. postfix has to be installed as an website internet server, 
the address I use is <code>pdb.fulham.com</code></p>
<pre>
brice@pdb:~/productdatabase$ sudo apt-get install postfix
[sudo] password for brice: 
Reading package lists... Done
...
brice@pdb:~/productdatabase$
</pre>
<h2>spawning</h2>
<p>
Spawning will multithread django which make it looks even more cool !
</p>
<pre>
brice@pdb:~/productdatabase$ sudo apt-get install python-setuptools build-essential libssl-dev
[sudo] password for brice: 
Reading package lists... Done
Building dependency tree       
Reading state information... Done
...
brice@pdb:~/productdatabase$ sudo easy_install -U setuptools
brice@pdb:~/productdatabase$ sudo easy_install spawning
Searching for spawning
...
Finished processing dependencies for spawning
brice@pdb:~/productdatabase$ 
</pre>
<h2>supervisor</h2>
<p>
    In order to maintain the process as easy as possible, supervisor will be mastering django
    launches !
</p>
<pre>
brice@pdb:~/productdatabase$ sudo easy_install supervisor 
Searching for supervisor
...
Finished processing dependencies for supervisor
brice@pdb:~/productdatabase$ sudo mkdir /var/log/supervisord/
brice@pdb:~/productdatabase$ 
</pre>
Then you can create supervisord.conf and put this configuration inside. Remember to change 
the directory of pdb (here /home/brice/productdatabase) by yours:
<pre>
[unix_http_server]
file=/tmp/supervisor.sock   ; (the path to the socket file)

[supervisord]
logfile=/var/log/supervisord/supervisord.log ; (main log file;default $CWD/supervisord.log)
logfile_maxbytes=50MB       ; (max main logfile bytes b4 rotation;default 50MB)
logfile_backups=10          ; (num of main logfile rotation backups;default 10)
loglevel=debug               ; (log level;default info; others: debug,warn,trace)
pidfile=/var/run/supervisord.pid ; (supervisord pidfile;default supervisord.pid)
nodaemon=false              ; (start in foreground if true;default false)
minfds=1024                 ; (min. avail startup file descriptors;default 1024)
minprocs=200                ; (min. avail process descriptors;default 200)
user=root                 ; (default is current user, required if root)
childlogdir=/var/log/supervisord/            ; ('AUTO' child log dir, default $TEMP)

[rpcinterface:supervisor]
supervisor.rpcinterface_factory = supervisor.rpcinterface:make_main_rpcinterface

[supervisorctl]
serverurl=unix:///tmp/supervisor.sock ; use a unix:// URL  for a unix socket

[program:pdb]
directory=/home/brice/productdatabase
command=/usr/bin/spawn  --factory=spawning.django_factory.config_factory settings --port=9000
process_name=%(program_name)s ; process_name expr (default %(program_name)s)
autostart=true                ; start at supervisord start (default: true)
autorestart=true              ; retstart at unexpected quit (default: true)
user=brice
stdout_logfile=/var/log/pdb_dev.log        ; stdout log path, NONE for none; default AUTO
stdout_logfile_maxbytes=1MB   ; max # logfile bytes b4 rotation (default 50MB)
stdout_logfile_backups=10     ; # of stdout logfile backups (default 10)
stdout_capture_maxbytes=1MB   ; number of bytes in 'capturemode' (default 0)
stderr_logfile=/var/log/pdb_dev_error.log        ; stderr log path, NONE for none; default AUTO
stderr_logfile_maxbytes=1MB   ; max # logfile bytes b4 rotation (default 50MB)
stderr_logfile_backups=10     ; # of stderr logfile backups (default 10)
stderr_capture_maxbytes=1MB   ; number of bytes in 'capturemode' (default 0)
</pre>
<p>
    Make sur that /usr/local/bin/spawn is the right path (the command <code>whereis spawn</code> will show it)
    to your installation of spawning. To run spawning we will use an init script. 
    Create /etc/init.d/supervisord
</p>
<pre>
#!/bin/bash -e

supervisord=/usr/local/bin/supervisord
supervisorctl=/usr/local/bin/supervisorctl
name="supervisor"

[ -f $supervisord ] || exit 1
[ -f $supervisorctl ] || exit 1

RETVAL=0

start() {
     echo -n "Starting $name: "
     $supervisord
     RETVAL=$?
     [ $RETVAL -eq 0 ] && touch /var/lock/subsys/$name
     echo
     return $RETVAL
}

stop() {
     echo -n "Stopping $name: "
     $supervisorctl shutdown
     RETVAL=$?
     [ $RETVAL -eq 0 ] && rm -f /var/lock/subsys/$name
     echo
     return $RETVAL
}

case "$1" in
         start)
             start
             ;;

         stop)
             stop
             ;;

         restart)
             stop
             start
             ;;
esac

exit $REVAL
</pre>
<p>
    Again, make sure that supervisord and supervisorctl are the right places ! Then we can add this
    script by adding it to the correct init script, so the server will turn on by itself if the 
    server is restarted
</p>
<pre>
brice@pdb:~$ sudo chmod +x /etc/init.d/supervisord
brice@pdb:~$ sudo update-rc.d supervisord start 89 S .
brice@pdb:~$ sudo /etc/init.d/supervisord start
</pre>

<h2>product database software</h2>
<p>
It's now time to install our main software. For now, there is no central repository for the product
database server, so the process will be a more complicated - thanks to Peter - and will not explain
how to do it here because it doesn't make sense to copy a repository instead of cloning it!
Next step is the setup file settings_local.py in our productdatabase project folder. 
Create this file and put this inside:
</p>
<pre>
# Django settings for productdatabase project.
DEBUG = True

ADMINS = (
    ('Brice Leroy', 'bleroy@fulham.com'),
)


DATABASE_ENGINE = 'mysql'           # 'postgresql_psycopg2', 'postgresql', 'mysql', 'sqlite3' or 'oracle'.
DATABASE_NAME = 'pdb'             # Or path to database file if using sqlite3.
DATABASE_USER = 'pdb_user'             # Not used with sqlite3.
DATABASE_PASSWORD = 'mysal_password'         # Not used with sqlite3.
DATABASE_HOST = ''             # Set to empty string for localhost. Not used with sqlite3.
DATABASE_PORT = ''             # Set to empty string for default. Not used with sqlite3.

# Local time zone for this installation. Choices can be found here:
# http://en.wikipedia.org/wiki/List_of_tz_zones_by_name
# although not all choices may be available on all operating systems.
# If running in a Windows environment this must be set to the same as your
# system time zone.
TIME_ZONE = 'America/Chicago'

# Language code for this installation. All choices can be found here:
# http://www.i18nguy.com/unicode/language-identifiers.html
LANGUAGE_CODE = 'en-us'

SITE_ID = 1

# If you set this to False, Django will make some optimizations so as not
# to load the internationalization machinery.
USE_I18N = True


# Make this unique, and don't share it with anybody.
SECRET_KEY = '2fvk@#oSD%(;Has235S9B3C#&AMV83%DKktucA60/.]1!@~113'
</pre>
<p>
You will have to replace the <code>SECRET_KEY</code> by another random value of your choice and set the
variable <code>DATABASE_PASSWORD</code> with the password you set for the user pdb_user. We can now
synchronize the database:
</p>
<pre>
brice@pdb:~/productdatabase$ mkdir media
brice@pdb:~/productdatabase$ mkdir media/product_document
brice@pdb:~/productdatabase$ mkdir media/product_picture
brice@pdb:~/productdatabase$ sudo apt-get install python-imaging
Reading package lists... Done
Building dependency tree       
...
ldconfig deferred processing now taking place
brice@pdb:~/productdatabase$ ./manage.py syncdb
Creating table auth_permission
Creating table auth_group
Creating table auth_user
Creating table auth_message
Creating table django_content_type
Creating table django_session
Creating table django_site
Creating table django_admin_log
Creating table picture_picture
Creating table product_category
Creating table product_product
Creating table product_import
Creating table document_document
Creating table inventory_warehouse
Creating table inventory_inventory
Creating table djangodblog_errorbatch
Creating table djangodblog_error
Creating table stockquery_stockcheck

You just installed Django's auth system, which means you don't have any superusers defined.
Would you like to create one now? (yes/no): yes
Username (Leave blank to use 'brice'): 
E-mail address: bleroy@fulham.com
Password: 
Password (again): 
Superuser created successfully.
Installing index for auth.Permission model
Installing index for auth.Message model
Installing index for admin.LogEntry model
Installing index for product.Product model
Installing index for inventory.Inventory model
Installing index for djangodblog.ErrorBatch model
Installing index for djangodblog.Error model
Installing index for stockquery.StockCheck model
brice@pdb:~/productdatabase$ 
</pre>
<h1>maintenance</h1>
<h2>Unit Test</h2>
<p>The Product database server has been developed with tests to ensure consistency. Each time you
make a modification it must run them to avoid functionnality breaking. To run all of them:
</p>
<pre>
brice@pdb:~/productdatabase$ ./manage.py test
Creating test database...
Creating table auth_permission
Creating table auth_group
...
</pre>
<p>
You should see a <strong>.</strong> for every successful test. Remember that without the
authentification patch you will get a couple of <strong>F</strong> meaning a failure.
</p>
<h2>Backup</h2>
<p>Since the source are GIT managed you can just clone it. To backup the whole site,
you need to save the media directory, the database and the settings_local.py</p>
<pre>
brice@pdb:~$ mysqldump  --add-drop-table -c -u pdb_user pdb -p > django.sql
Enter password: 
brice@pdb:~$ tar czf django_backup.tgz productdatabase/media productdatabase/settings_local.py django.sql                 
</pre>
<p>
Those command will provide you a full backup of your actual installation. You have now to transfert
the file django_backup.tgz on a safe place.
</p>

<h1>administration</h1>
<p>Django comes with a ready to use administration. Only users with staff property checked will have 
an access to the admin page. To access the admin page go to 
<a href="https://pdb.fulham.com/admin">https://pdb.fulham.com/admin</a>. 
</p>
<p>It's recommanded to manage your user rights through group and them adhere them to this group </p>
<p>
<img src="adminpanel.jpg" />
</p>
<ol>
<li>Allow you to quickly add a new record</li>
<li>Redirect you to the list of items contained by this module to operate changes</li>
<li>List the previous changes you've done</li>
<li>Direct access to module, act like change</li>
<li>Change password and logout from the admin</li>
</ol>
<h2>group creation</h2>
<p> To start, in the group module section, click on add link. As an exemple, we will create the
distributor group that can see products regular prices, distributor stock price and can see
product availability:
<p>
<img src="groups.jpg" />
</p>
<ol>
<li>Filter, you can enter a part of the permission title</li>
<li>To delete a permission you can double click it</li>
<li>Each edition page can be saved by those buttons</li>
</ol>

<p>The principals rights are:</p>
<ul>
    <li> <strong>REST Interface:</strong> </li>
    <ul>
    <li>REST-Can update an existing product: the user can send a POST REST request to modify data</li>
    <li>REST-Can delete a product: the user can send a DELETE REST request to delete a record</li>
    <li>REST-Can create a new product: the user can send a PUT REST request to update an existing record</li>
    <li>REST-Can read a product property: the user can view the XML of a product and see if the product is available(not the quantity)</li>
    <li>REST-Can read all product in one request: the user can get the whole catalog in one request</li>
    <li>REST-Can see quantity in stock: the user can see the quantity in every stock</li>
    </ul>
    <li><strong>Web Interface:</strong></li>
    <ul>
    <li>Can see quantity in stock: user see the quantity in all our different stock</li>
    <li>Can check product availability: user can check if the product is available but cannot see the quantity in stock</li>
    <li>Can see listed price:user can see regular catalog price</li>
    <li>Can see distributor with stock price: user can see the distributor price when their product are stored in our warehouse</li>
    <li>Can see distributor without stock price: user can see the distributor price</li>
    </ul>
</ul>

<h2>user creation</h2>
<p>When you have setup the groups, you can now create user using the add user button in the user module</p>
<p><img src="user_creation.png" /></p>
<p>This example show you a rest user with full access to the rest interface. It is not using the group
so I can show which right are selected. It's always recommended to use group to manage right.</p>
<h2>inventory import</h2>
<img src="inventory_import.png" />
<p>An import consist in a CSV file. Common spreadsheet allow you to import a table to a CSV. 
The first column should contain the item number, the other column are the quantity in stock. 
The import will read the first line and generate warehouse if they don't exist. <a href="example.csv">Here is an exemple</a>
</p>
<ol>
    <li>To create a new import, click here.</li>
    <li>This section allow you to make short filter on existing import record.</li>
    <li>Each record you want to import have to be checked here.</li>
    <li>Once you have checked the needed records, select "Import selected Inventory" and click go.</li>
</ol>
<h1>web user interface</h1>
<h2>product list</h2>
<p>The product list view show you paginated version of the products. It display up to 10 items per
pages. </p>
<p><img src="product_list.png" /></p>
<ol>
<li>On every page you will see this link to log yourself out of the system.</li>
<li>You can filter the list by indicating a category or a part of the item number. If only one item
is find with the filter you set the product will directly show up.</li>
<li>This line show how many document this item contains and a part of the description.</li>
<li>The next and previous link allow you to browse the product list.</li>
</ol>
<h2>product detail</h2>
<p><img src="product_detail.png" /></p>
<ol>
<li>shorcut to the search. The search is done on the item number.</li>
<li>Property tables, will show different properties according to your permissions in the system.</li>
<li>Every picture and document link to the current item can be see by clicking here. You can also
have the stock appearing here or the stock query if you cannot access the quantity in stock.</li>
<li>This link bring you back to the product list page</li>
</ol>
<h1>rest interface</h1>
<h2>Authentication</h2>
<p>
 REST API needs you to authentify using HTTP1.0 (<a href="http://tools.ietf.org/html/rfc1945">rfc1945</a>).
 I choosed this protocol because it is protected by the SSL layer. The authentification has to
 be include the header of the request. Following is an exemple of authentification using python:
</p>

<pre>
from binascii import b2a_base64
import urllib2
req = urllib2.Request('https://pdb.fulham.com/product/xml/TLMR160355CW/')
req.add_header('AUTHORIZATION','Basic %s' % b2a_base64('username:password')[:-1])
response = urllib2.urlopen(req)
print response.read()
</pre>
<p> If you copy and past the commands above in a python console, you should obtain this result:</p>
<pre>
brice@ubuntuserver64:~/django-db-log$ python
Python 2.6.2 (release26-maint, Apr 19 2009, 01:58:18) 
[GCC 4.3.3] on linux2
Type "help", "copyright", "credits" or "license" for more information.
>>> from binascii import b2a_base64
>>> import urllib2
>>> req = urllib2.Request('https://pdb.fulham.com/product/xml/TLMR1607HP40C/')
>>> req.add_header('AUTHORIZATION','Basic %s' % b2a_base64('username:password')[:-1])
>>> response = urllib2.urlopen(req)
>>> print response.read()
</pre>
<p>The last line is supposed to give you this result (depending how many things you did import):</p>
<div class="highlight" ><pre><span style="color: #007020">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span>
<span style="color: #062873; font-weight: bold">&lt;objects&gt;</span>
<span style="color: #062873; font-weight: bold">&lt;object</span> <span style="color: #4070a0">pk=&quot;3&quot;</span> <span style="color: #4070a0">model=&quot;product.product&quot;</span><span style="color: #062873; font-weight: bold">&gt;</span>
    <span style="color: #062873; font-weight: bold">&lt;property</span> <span style="color: #4070a0">name=&quot;item_number&quot;</span><span style="color: #062873; font-weight: bold">&gt;</span>TLMR1607HP40C<span style="color: #062873; font-weight: bold">&lt;/property&gt;</span>
    <span style="color: #062873; font-weight: bold">&lt;property</span> <span style="color: #4070a0">name=&quot;title&quot;</span><span style="color: #062873; font-weight: bold">&gt;</span>TLMR1607HP40C<span style="color: #062873; font-weight: bold">&lt;/property&gt;</span>
    <span style="color: #062873; font-weight: bold">&lt;property</span> <span style="color: #4070a0">name=&quot;description&quot;</span><span style="color: #062873; font-weight: bold">&gt;</span>LED MR 16 7W 40 DEG. 5500K <span style="color: #062873; font-weight: bold">&lt;/property&gt;</span>
    <span style="color: #062873; font-weight: bold">&lt;property</span> <span style="color: #4070a0">name=&quot;length&quot;</span> <span style="color: #4070a0">uom=&quot;in&quot;</span><span style="color: #062873; font-weight: bold">&gt;</span>None<span style="color: #062873; font-weight: bold">&lt;/property&gt;</span>
    <span style="color: #062873; font-weight: bold">&lt;property</span> <span style="color: #4070a0">name=&quot;width&quot;</span> <span style="color: #4070a0">uom=&quot;in&quot;</span><span style="color: #062873; font-weight: bold">&gt;</span>None<span style="color: #062873; font-weight: bold">&lt;/property&gt;</span>
    <span style="color: #062873; font-weight: bold">&lt;property</span> <span style="color: #4070a0">name=&quot;height&quot;</span> <span style="color: #4070a0">uom=&quot;in&quot;</span><span style="color: #062873; font-weight: bold">&gt;</span>None<span style="color: #062873; font-weight: bold">&lt;/property&gt;</span>
    <span style="color: #062873; font-weight: bold">&lt;property</span> <span style="color: #4070a0">name=&quot;activity_code&quot;</span><span style="color: #062873; font-weight: bold">&gt;</span>A<span style="color: #062873; font-weight: bold">&lt;/property&gt;</span>
    <span style="color: #062873; font-weight: bold">&lt;property</span> <span style="color: #4070a0">name=&quot;un_spsc_code&quot;</span><span style="color: #062873; font-weight: bold">&gt;</span>32111503<span style="color: #062873; font-weight: bold">&lt;/property&gt;</span>
    <span style="color: #062873; font-weight: bold">&lt;property</span> <span style="color: #4070a0">name=&quot;dist_velocity_code&quot;</span><span style="color: #062873; font-weight: bold">&gt;</span>C<span style="color: #062873; font-weight: bold">&lt;/property&gt;</span>
    <span style="color: #062873; font-weight: bold">&lt;property</span> <span style="color: #4070a0">name=&quot;wattage&quot;</span><span style="color: #062873; font-weight: bold">&gt;</span>8W<span style="color: #062873; font-weight: bold">&lt;/property&gt;</span>
    <span style="color: #062873; font-weight: bold">&lt;property</span> <span style="color: #4070a0">name=&quot;base&quot;</span><span style="color: #062873; font-weight: bold">&gt;</span>GX 5.3<span style="color: #062873; font-weight: bold">&lt;/property&gt;</span>
    <span style="color: #062873; font-weight: bold">&lt;property</span> <span style="color: #4070a0">name=&quot;page&quot;</span><span style="color: #062873; font-weight: bold">&gt;</span>Catalog pg # 6<span style="color: #062873; font-weight: bold">&lt;/property&gt;</span>
    <span style="color: #062873; font-weight: bold">&lt;property</span> <span style="color: #4070a0">name=&quot;upc&quot;</span><span style="color: #062873; font-weight: bold">&gt;&lt;/property&gt;</span>
    <span style="color: #062873; font-weight: bold">&lt;object</span> <span style="color: #4070a0">pk=&quot;81&quot;</span> <span style="color: #4070a0">model=&quot;picture.picture&quot;</span><span style="color: #062873; font-weight: bold">&gt;</span>
        <span style="color: #062873; font-weight: bold">&lt;property</span> <span style="color: #4070a0">name=&quot;title&quot;</span><span style="color: #062873; font-weight: bold">&gt;&lt;/property&gt;</span>
        <span style="color: #062873; font-weight: bold">&lt;property</span> <span style="color: #4070a0">name=&quot;url&quot;</span><span style="color: #062873; font-weight: bold">&gt;</span>http://pdb.fulham.com/media/product_picture/tmpb_s6TL.jpg<span style="color: #062873; font-weight: bold">&lt;/property&gt;</span>
    <span style="color: #062873; font-weight: bold">&lt;/object&gt;</span>
    <span style="color: #062873; font-weight: bold">&lt;object</span> <span style="color: #4070a0">pk=&quot;148&quot;</span> <span style="color: #4070a0">model=&quot;document.document&quot;</span><span style="color: #062873; font-weight: bold">&gt;</span>
        <span style="color: #062873; font-weight: bold">&lt;property</span> <span style="color: #4070a0">name=&quot;title&quot;</span><span style="color: #062873; font-weight: bold">&gt;&lt;/property&gt;</span>
        <span style="color: #062873; font-weight: bold">&lt;property</span> <span style="color: #4070a0">name=&quot;url&quot;</span><span style="color: #062873; font-weight: bold">&gt;</span>http://pdb.fulham.com/media/product_document/tmpCBF5oZ.pdf<span style="color: #062873; font-weight: bold">&lt;/property&gt;</span>
    <span style="color: #062873; font-weight: bold">&lt;/object&gt;</span>
    <span style="color: #062873; font-weight: bold">&lt;object</span> <span style="color: #4070a0">pk=&quot;13487&quot;</span> <span style="color: #4070a0">model=&quot;inventory.inventory&quot;</span><span style="color: #062873; font-weight: bold">&gt;</span>
        <span style="color: #062873; font-weight: bold">&lt;property</span> <span style="color: #4070a0">name=&quot;warehouse&quot;</span><span style="color: #062873; font-weight: bold">&gt;</span>Avail-CA<span style="color: #062873; font-weight: bold">&lt;/property&gt;</span>
        <span style="color: #062873; font-weight: bold">&lt;property</span> <span style="color: #4070a0">name=&quot;quantity&quot;</span><span style="color: #062873; font-weight: bold">&gt;</span>75.0<span style="color: #062873; font-weight: bold">&lt;/property&gt;</span>
        <span style="color: #062873; font-weight: bold">&lt;property</span> <span style="color: #4070a0">name=&quot;date&quot;</span><span style="color: #062873; font-weight: bold">&gt;</span>2009-10-19 14:52:22<span style="color: #062873; font-weight: bold">&lt;/property&gt;</span>
    <span style="color: #062873; font-weight: bold">&lt;/object&gt;</span>
    <span style="color: #062873; font-weight: bold">&lt;object</span> <span style="color: #4070a0">pk=&quot;13488&quot;</span> <span style="color: #4070a0">model=&quot;inventory.inventory&quot;</span><span style="color: #062873; font-weight: bold">&gt;</span>
        <span style="color: #062873; font-weight: bold">&lt;property</span> <span style="color: #4070a0">name=&quot;warehouse&quot;</span><span style="color: #062873; font-weight: bold">&gt;</span>Avail-FL<span style="color: #062873; font-weight: bold">&lt;/property&gt;</span>
        <span style="color: #062873; font-weight: bold">&lt;property</span> <span style="color: #4070a0">name=&quot;quantity&quot;</span><span style="color: #062873; font-weight: bold">&gt;</span>25.0<span style="color: #062873; font-weight: bold">&lt;/property&gt;</span>
        <span style="color: #062873; font-weight: bold">&lt;property</span> <span style="color: #4070a0">name=&quot;date&quot;</span><span style="color: #062873; font-weight: bold">&gt;</span>2009-10-19 14:52:22<span style="color: #062873; font-weight: bold">&lt;/property&gt;</span>
    <span style="color: #062873; font-weight: bold">&lt;/object&gt;</span>
    <span style="color: #062873; font-weight: bold">&lt;object</span> <span style="color: #4070a0">pk=&quot;13489&quot;</span> <span style="color: #4070a0">model=&quot;inventory.inventory&quot;</span><span style="color: #062873; font-weight: bold">&gt;</span>
        <span style="color: #062873; font-weight: bold">&lt;property</span> <span style="color: #4070a0">name=&quot;warehouse&quot;</span><span style="color: #062873; font-weight: bold">&gt;</span>InTransit<span style="color: #062873; font-weight: bold">&lt;/property&gt;</span>
        <span style="color: #062873; font-weight: bold">&lt;property</span> <span style="color: #4070a0">name=&quot;quantity&quot;</span><span style="color: #062873; font-weight: bold">&gt;</span>0.0<span style="color: #062873; font-weight: bold">&lt;/property&gt;</span>
        <span style="color: #062873; font-weight: bold">&lt;property</span> <span style="color: #4070a0">name=&quot;date&quot;</span><span style="color: #062873; font-weight: bold">&gt;</span>2009-10-19 14:52:22<span style="color: #062873; font-weight: bold">&lt;/property&gt;</span>
    <span style="color: #062873; font-weight: bold">&lt;/object&gt;</span>
<span style="color: #062873; font-weight: bold">&lt;/object&gt;</span>
<span style="color: #062873; font-weight: bold">&lt;/objects&gt;</span>
</pre></div>

<h2>rest URLs</h2>
<p>
Here is the couple of exemple of urls that can be used on the rest API.
</p>
<h3>reading record</h3>
<p>To read data, the method should be GET.</p>
<ul>
    <li><code>https://pdb.fulham.com/product/xml/TLMR1607HP40C/</code>: return the full information regarding a product</li>
    <li><code>https://pdb.fulham.com/product/xml/TLMR1607HP40C/<strong>20</strong>/</code>: Check if 20 items are available</li>
    <li><code>https://pdb.fulham.com/product/xml/</code>: Return the full listing</li>
</ul>
<h3>deleting record</h3>
<p>To delete a record, the method should be DELETE, then calling <code>https://pdb.fulham.com/product/xml/TLMR1607HP40C/</code>
will delete the product with the item_number TLMR1607HP40C</p>
<h3>updating record</h3>
<p>to update a record, the method should be PUT, then calling <code>https://pdb.fulham.com/product/xml/TLMR1607HP40C/</code>
will update the tiem TLMR1607HP40C. Each property you send will update the record designated by the url.</p>
<h3>creating record</h3>
<p>Same as updating record but will create a new one. The url is <code>https://pdb.fulham.com/product/xml/</code> and you
have to provide all the informations</p>
</body>
